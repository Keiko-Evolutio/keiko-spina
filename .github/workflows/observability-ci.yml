name: 🔍 Observability CI - Phase 4.1

on:
  push:
    branches: [ main, develop ]
    branches-ignore: [dev]  # Keine Observability-Tests beim Merge nach dev
    paths:
      - '../../src/observability/**'
      - '../../src/monitoring/**'
      - '../../src/tests/monitoring/**'
      - '../../../docker-compose.observability.yml'

  pull_request:
    branches: [ main, develop ]
    branches-ignore: [dev]  # Keine Observability-Tests bei PRs nach dev
    paths:
      - '../../src/observability/**'
      - '../../src/monitoring/**'

# Minimal permissions für Observability CI
permissions:
  contents: read          # Read repository contents
  actions: read          # Read workflow artifacts

jobs:
  validate-observability:
    name: 🔍 Validate Observability Implementation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 📦 Install Dependencies
        run: |
          cd backend
          pip install opentelemetry-api opentelemetry-sdk
          pip install opentelemetry-instrumentation-fastapi
          pip install opentelemetry-exporter-otlp
          pip install prometheus-client
          pip install pytest pytest-asyncio

      - name: 🚀 Start Observability Stack
        run: |
          cd backend
          docker compose -f docker-compose.observability.yml up -d
          sleep 30

      - name: 🏥 Check Service Health
        run: |
          curl -f http://localhost:13133 || exit 1
          curl -f http://localhost:16686 || exit 1
          curl -f http://localhost:9090/-/healthy || exit 1
          curl -f http://localhost:3000/api/health || exit 1

      - name: 🔍 Validate Implementation
        run: |
          cd backend
          python validate_phase4_implementation.py --verbose

      - name: 🧹 Cleanup
        if: always()
        run: |
          cd backend
          docker compose -f docker-compose.observability.yml down -v
